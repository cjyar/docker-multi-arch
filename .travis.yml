addons:
  apt:
    packages:
    - docker.io

env:
  global:
  - VERSION=${TRAVIS_BRANCH}
  - DOCKER_USERNAME=cjyar
  # DOCKER_PASSWORD:
  - secure: "OcdoiywEO0wPGnMxT5inBdATlK1CfpW/UkBHn2s5xaKyCvz+zDHxxRRprrhH1uqZm0SVj6zdjTsYDseVg9++eqIFR+T5H+M6ifpW3BRkAY1CJeC+WSMA4PAMd7LdOWmRK3m9bEUNuUdlLEmZDoprSWSwvBw5gTodS8ltO8vvtm6atVUlgZ5JqA7jUbDXYr3xJykQAId2paQbUrIQnwAvXtqBv1NP7yVZP23/LzYqcSjuGgSUyV8lteqELqoRLGtLDk/6LQlcjPrnSXtPtRZZwJt4+ZcbfVdRHpPREZ2WaBITuQTS1/GaMX9g3ORj51VhbYgyx4kxJXZmEsFWMiReNopaB1XFx4PhKkpPiIkiz9flNpY5Chc2eRKQhq+ewJLP4SCqzBUP1i0Vu4xrUS8TvvTiHxdUB7tMsw5tXEw8zjzIBitquuXXxo7xEROuCTPKvc/VHHrpbEVGAu8pX0vk6mPeNqGZgW4nP6H09+AItzRavJnKwYy2DO0uPwwCUl0wpceCOanXbybY49enZ5wZqGsqgjE1v8Nj6jG0g/ja8kr/XQESLr2FqApyH5qrFw6gaXjPSfEVQk7XXLnz28TnOUN3sdb0w71snHRD+rF62VxqfYUN12ax/J+t9MsLi4hH35THreb42W3150mGmey8rg6vvlyaFBQBmpD+Rp1bniw="

arch:
- amd64
- arm64
- ppc64le
- s390x

services:
- docker

before-script:
# Enable experimental mode so we can manipulate manifest lists.
- mkdir -p ${HOME}/.docker
- echo '{"experimental":"enabled"}' > ${HOME}/.docker/config.json
# Set up Docker authentication.
- docker login -u ${DOCKER_USERNAME} -p ${DOCKER_PASSWORD}

script:
# Build on this architecture, then tag and push this image.
- docker build -t test .
- docker tag test cjyar/tt:${TRAVIS_CPU_ARCH}-${VERSION}
- docker push cjyar/tt:${TRAVIS_CPU_ARCH}-${VERSION}

# This deploy stage only runs once, skipping the build matrix.
jobs:
  include:
  - stage: deploy
    script:
    # Create the manifest list which ties together all the images from the different architectures.
    - docker manifest create cjyar/tt:${VERSION} cjyar/tt:amd64-${VERSION} cjyar/tt:arm64-${VERSION} cjyar/tt:ppc64le-${VERSION} cjyar/tt:s390x-${VERSION}
    - docker manifest push cjyar/tt:${VERSION}
